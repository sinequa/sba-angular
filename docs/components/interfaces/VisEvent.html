<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Components</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Components</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>VisEvent</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>network/network.component.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Structure of the events emitted by the Vis.js network</p>

            </p>


        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#edges">edges</a>
                                </li>
                                <li>
                                        <a href="#event">event</a>
                                </li>
                                <li>
                                        <a href="#items">items</a>
                                </li>
                                <li>
                                        <a href="#nodes">nodes</a>
                                </li>
                                <li>
                                        <a href="#pointer">pointer</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="edges"></a>
                                        <span class="name"><b>edges</b><a href="#edges"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>edges:     <code>string[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="event"></a>
                                        <span class="name"><b>event</b><a href="#event"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>event:         <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="items"></a>
                                        <span class="name"><b>items</b><a href="#items"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>items:     <code>any[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>any[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="nodes"></a>
                                        <span class="name"><b>nodes</b><a href="#nodes"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>nodes:     <code>string[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="pointer"></a>
                                        <span class="name"><b>pointer</b><a href="#pointer"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>pointer:         <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, Input, OnChanges, SimpleChanges, OnDestroy, Output, EventEmitter, ContentChild, TemplateRef } from &#x27;@angular/core&#x27;;
import { FormGroup, FormControl, FormBuilder } from &#x27;@angular/forms&#x27;;
import { Subscription, combineLatest } from &#x27;rxjs&#x27;;

import { Results } from &#x27;@sinequa/core/web-services&#x27;;
import { AppService } from &#x27;@sinequa/core/app-utils&#x27;;
import { Utils } from &#x27;@sinequa/core/base&#x27;;
import { UserPreferences } from &#x27;@sinequa/components/user-settings&#x27;;
import { AbstractFacet } from &#x27;@sinequa/components/facet&#x27;;
import { Action } from &#x27;@sinequa/components/action&#x27;;
import { SearchService } from &#x27;@sinequa/components/search&#x27;;

import { Options, VisNetworkService } from &#x27;ngx-vis&#x27;;
import { DataSet } from &quot;vis-data/peer/esm/vis-data&quot;;

import { Node, Edge, NetworkDataset, NetworkProvider, NetworkContext } from &#x27;./network-models&#x27;;
import { IntlService } from &#x27;@sinequa/core/intl&#x27;;

/**
 * Default options of the Vis.js network.
 * See: https://visjs.github.io/vis-network/docs/network/
 */
export const defaultOptions: Options &#x3D; {
    height: &#x27;500px&#x27;,
    interaction: {
        navigationButtons: true // For the buttons to be displayed, it is necessary to import the stylesheet &quot;~vis-network/dist/vis-network.min.css&quot;
    }
};

/**
 * Structure of the events emitted by the Vis.js network
 */
export interface VisEvent {
    nodes: string[];
    edges: string[];
    event: any;
    items: any[];
    pointer: any;
}

@Component({
    selector: &#x27;sq-network&#x27;,
    templateUrl: &#x27;./network.component.html&#x27;
})
export class NetworkComponent extends AbstractFacet implements OnChanges, OnDestroy {

    /** Name of the network - should be unique within the app */
    @Input() name &#x3D; &quot;Network&quot;;

    /** Input results - used to produce a OnChange event when  */
    @Input() results: Results;
    
    @Input() providers: NetworkProvider[];

    /** General Vis options passed to the network (https://visjs.github.io/vis-network/docs/network/) */
    @Input() options: Options &#x3D; defaultOptions;
    optionsPrefs: Options;
    
    @Output() nodeClicked &#x3D; new EventEmitter&lt;Node&gt;();
    @Output() edgeClicked &#x3D; new EventEmitter&lt;Edge&gt;();
  
    // Settings form
    form: FormGroup;

    // State
    _networkInitialized: boolean;
    _selectedNode?: Node;
    _selectedEdge?: Edge;

    // Actions
    _actions: Action[] &#x3D; [];
    refreshAction: Action;
    clearFilters: Action;

    // Info cards
    @ContentChild(&quot;nodeTpl&quot;, {static: false}) nodeTpl: TemplateRef&lt;any&gt;;
    @ContentChild(&quot;edgeTpl&quot;, {static: false}) edgeTpl: TemplateRef&lt;any&gt;;
    
    readonly context: NetworkContext;

    providersSubscription: Subscription;

    constructor(
        public networkService: VisNetworkService,
        public searchService: SearchService,
        public appService: AppService,
        public intlService: IntlService,
        public formBuilder: FormBuilder,
        public prefs: UserPreferences
    ) {
        super();

        // Notify providers when a node is clicked (this may trigger new data, or a node mutation)
        this.nodeClicked.subscribe((node?: Node) &#x3D;&gt; {
            this.providers.forEach(p &#x3D;&gt; p.onNodeClicked(node));
        });
        
        // Notify providers when a node is clicked (this may trigger new data, or a node mutation)
        this.edgeClicked.subscribe((edge?: Edge) &#x3D;&gt; {
            this.providers.forEach(p &#x3D;&gt; p.onEdgeClicked(edge));
        });

        // Refresh the network
        this.refreshAction &#x3D; new Action({
            icon: &quot;fas fa-sync-alt&quot;,
            title: &quot;msg#network.actions.refresh&quot;,
            action: () &#x3D;&gt; {
                this.updateData();
                this.updateActions();
            }
        });
        
        // Clear the current filters
        this.clearFilters &#x3D; new Action({
            icon: &quot;far fa-minus-square&quot;,
            title: &quot;msg#facet.clearSelects&quot;,
            action: () &#x3D;&gt; {
                this.searchService.query.removeSelect(this.name);
                this.searchService.search();
            }
        });

        this.context &#x3D; {
            name: this.name,
            nodes: new DataSet&lt;Node&gt;(),
            edges: new DataSet&lt;Edge&gt;(),
            searchService: searchService,
            appService: appService,
            networkService: networkService,
            intlService: intlService,
            select: (node?: Node, edge?: Edge) &#x3D;&gt; this.select(node, edge),
        };
    }

    ngOnChanges(changes: SimpleChanges) {

        if(changes[&#x27;results&#x27;] || changes[&#x27;providers&#x27;]) {
            // Update the context
            this.context.name &#x3D; this.name;

            // Update selections
            this.selectEdge();
            this.selectNode();

            // Update options from the preferences
            this.updateOptions();

            // Update data from the providers (async)
            this.updateData();

            // Update the actions of the facet
            this.updateActions();
        }

    }

    /**
     * Resets the nodes and edges, create a new listener for the providers and
     * call getData() on these providers to refresh the data
     */
    protected updateData() {
        
        this.context.nodes.clear();
        this.context.edges.clear();

        if(this.providersSubscription){
            this.providersSubscription.unsubscribe();
        }

        this.providersSubscription &#x3D; combineLatest(
            this.providers.map(p &#x3D;&gt; p.getProvider())
        ).subscribe(datasets &#x3D;&gt; 
            this.mergeDatasets(datasets.filter(d &#x3D;&gt; !!d) as NetworkDataset[])
        );

        this.providers.forEach(p &#x3D;&gt; p.getData(this.context));
    }

    /**
     * Take in the datasets produced by each provider and merges them into
     * a single one
     * @param datasets 
     */
    protected mergeDatasets(datasets: NetworkDataset[]) {
        const dataset &#x3D; datasets.reduce((prev, cur) &#x3D;&gt; prev.merge(cur), new NetworkDataset());
        
        // Notify providers that nodes were inserted (which could trigger an update of the data)
        this.providers.forEach(p &#x3D;&gt; p.onDatasetsMerged(dataset));

        // TODO: Post process the dataset somehow to adjust visibility (or other properties)
        dataset.updateDatasets(this.context.nodes, this.context.edges);

        // Notify providers that nodes were inserted (which could trigger an update of the data)
        this.providers.forEach(p &#x3D;&gt; p.onNodesInserted(this.context.nodes.get()));

        this.updateActions();
    }

    get actions(): Action[] {
        return this._actions;
    }

    /**
     * Updates the actions displayed in the facet frame (_action variable).
     * Actions may come from this component or from its providers
     */
    protected updateActions() {
        this._actions &#x3D; [];

        // Clear the active filters
        if(this.searchService.breadcrumbs &amp;&amp; !!this.searchService.breadcrumbs.findSelect(this.name)) {
            this._actions.push(this.clearFilters);
        }

        // Selected node actions
        if(this._selectedNode) {
            this.providers.forEach(p &#x3D;&gt; {
                const actions &#x3D; p.getNodeActions(this._selectedNode!);
                if(actions.length){
                    this._actions &#x3D; this._actions.concat(actions);
                }
            });
        }

        // Selected edge actions
        if(this._selectedEdge) {
            this.providers.forEach(p &#x3D;&gt; {
                const actions &#x3D; p.getEdgeActions(this._selectedEdge!);
                if(actions.length){
                    this._actions &#x3D; this._actions.concat(actions);
                }
            });
        }

        // Actions specific to each provider
        const providersActionList &#x3D; new Action({
            icon: &quot;fas fa-tasks&quot;,
            title: &quot;msg#network.actions.providers&quot;,
            children: []
        });
        this.providers.forEach(p &#x3D;&gt; {
            const providerActions &#x3D; new Action({
                text: this.intlService.formatMessage(p.name),
                title: this.intlService.formatMessage(p.name)
            });
            providerActions.children &#x3D; p.getProviderActions();
            providersActionList.children.push(providerActions);
        });
        this._actions.push(providersActionList);

        // Action to refresh the network
        this._actions.push(this.refreshAction);

    }


    // Event handling

    /**
     * Called from the template by ngx-vis, when the network is initialized,
     * and the NetworkService can be used.
     */
    networkInitialized() {
        this._networkInitialized &#x3D; true;

        // now we can use the service to register on events
        this.networkService.on(this.name, &#x27;click&#x27;);
        
        this.networkService.click.subscribe((eventData: any[]) &#x3D;&gt; this.onNetworkClick(eventData));

        this.networkService.setOptions(this.name, this.optionsPrefs);
    }

    /**
     * Method called when a node or edge in the network is clicked.
     * The method generates appropriate nodeClicked and edgeClicked events,
     * and updates the state of _selectedEdge and _selectedNode.
     * @param eventData 
     */
    protected onNetworkClick(eventData: any[]) {
        if (eventData[0] &#x3D;&#x3D;&#x3D; this.name) {
            const event &#x3D; eventData[1] as VisEvent;

            if(event.event.type &#x3D;&#x3D;&#x3D; &quot;tap&quot;) {

                if(event.edges.length &#x3D;&#x3D;&#x3D; 1 &amp;&amp; event.nodes.length &#x3D;&#x3D;&#x3D; 0) {
                    this.selectEdge(this.context.edges.get(event.edges[0]) as Edge);
                    this.selectNode();
                }
                else {
                    this.selectEdge();
                    if(event.nodes.length &#x3D;&#x3D;&#x3D; 1) {
                        this.selectNode(this.context.nodes.get(event.nodes[0]) as Node);
                    }
                    else {
                        this.selectNode();
                    }
                }

            }
            else {
                this.selectNode();
                this.selectEdge();
            }
                        
            this.updateActions();
        }
    }

    select(node?: Node, edge?: Edge) {
        this.selectNode(node);
        this.selectEdge(edge);
        this.updateActions();
    }

    selectNode(node?: Node) {
        this._selectedNode &#x3D; node;
        this.nodeClicked.next(node);
    }

    selectEdge(edge?: Edge) {
        this._selectedEdge &#x3D; edge;
        this.edgeClicked.next();
    }

    ngOnDestroy() {
        this.networkService.off(this.name, &#x27;click&#x27;);
        if(this.providersSubscription){
            this.providersSubscription.unsubscribe();
        }
    }


    // Settings
    
    /**
     * Sets the options values either to the user preferences (stored in user settings)
     * or the default values.
     */
    updateOptions() {
        this.optionsPrefs &#x3D; Utils.copy(this.options);
        if(!this.optionsPrefs.physics){
            this.optionsPrefs.physics &#x3D; {};
        }
        if(!this.optionsPrefs.physics.barnesHut){
            this.optionsPrefs.physics.barnesHut &#x3D; {};
        }
        this.optionsPrefs.physics.barnesHut.springLength &#x3D; this.springLengthPref;
        this.optionsPrefs.physics.barnesHut.springConstant &#x3D; this.springConstantPref / 100;
        this.optionsPrefs.physics.barnesHut.damping &#x3D; this.dampingPref / 100;
        this.optionsPrefs.physics.barnesHut.gravitationalConstant &#x3D; -this.repulsionPref;
        this.optionsPrefs.physics.barnesHut.centralGravity &#x3D; this.gravityPref / 10;

        if(this._networkInitialized) {
            this.networkService.setOptions(this.name, this.optionsPrefs);
        }
    }

    /**
     * Method from the AbstractFacet interface called when the settings
     * panel is opened or closed
     * @param opened whether settings are opened or closed
     */
    onOpenSettings(opened: boolean){
        if(opened) {
            const springLengthControl &#x3D; new FormControl(this.springLengthPref);
            const springConstantControl &#x3D; new FormControl(this.springConstantPref);
            const dampingControl &#x3D; new FormControl(this.dampingPref);
            const repulsionControl &#x3D; new FormControl(this.repulsionPref);
            const gravityControl &#x3D; new FormControl(this.gravityPref);

            this.form &#x3D; this.formBuilder.group({
                springLength: springLengthControl,
                springConstant: springConstantControl,
                damping: dampingControl,
                repulsion: repulsionControl,
                gravity: gravityControl
            });

            this.form.valueChanges.subscribe(_ &#x3D;&gt; {
                this.prefs.set(this.name+&#x27;-spring-length&#x27;, springLengthControl.value, true);
                this.prefs.set(this.name+&#x27;-spring-constant&#x27;, springConstantControl.value, true);
                this.prefs.set(this.name+&#x27;-damping&#x27;, dampingControl.value, true);
                this.prefs.set(this.name+&#x27;-repulsion&#x27;, repulsionControl.value, true);
                this.prefs.set(this.name+&#x27;-gravity&#x27;, gravityControl.value, true);
                this.debounceSync();
            });
        }
        else {
            this.updateOptions();
            this.updateData();
        }
    }

    // Debounce syncing to avoid many calls to the user settings web service
    debounceSync &#x3D; Utils.debounce(() &#x3D;&gt; {
        this.prefs.sync();
    }, 1000);

    /**
     * This method resets all the user preferences and rebuilds the settings form,
     * so that the values displayed are up-to-date
     */
    setDefaults() {
        this.prefs.delete(this.name+&#x27;-spring-length&#x27;, true);
        this.prefs.delete(this.name+&#x27;-spring-constant&#x27;,true);
        this.prefs.delete(this.name+&#x27;-damping&#x27;, true);
        this.prefs.delete(this.name+&#x27;-repulsion&#x27;, true);
        this.prefs.delete(this.name+&#x27;-gravity&#x27;, true);
        this.prefs.sync();
        this.onOpenSettings(true);
    }

    // Accessor method for each of the settings.
    // Return either the saved user preference or the default value.

    get springLengthPref(): number {
        return this.prefs.get(this.name+&#x27;-spring-length&#x27;) || 100;
    }
    
    get springConstantPref(): number {
        return this.prefs.get(this.name+&#x27;-spring-constant&#x27;) || 4;
    }
    
    get dampingPref(): number {
        return this.prefs.get(this.name+&#x27;-damping&#x27;) || 50;
    }

    get repulsionPref(): number {
        return this.prefs.get(this.name+&#x27;-repulsion&#x27;) || 2000;
    }

    get gravityPref(): number {
        return this.prefs.get(this.name+&#x27;-gravity&#x27;) || 3;
    }
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'VisEvent.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
